### Instance состоит из:
>SGA (System Global Area), которая обеспечивает коммуникацию между процессами;
бэкграундовых процессов

# Файлы базы данных Oracle

### Файлы данных (Data Files).

Все данные в базе данных Oracle сохраняются в файлах данных. Все таблицы, индексы, триггеры, последовательности, программы
на PL/SQL, представления - все это находится в файлах данных.

### Оперативные файлы журналов повтора (Online Redo Log Files).

Предназначены для записи всех изменений, выполненных над данными базы данных Oracle. Используется для хранения на диске
информации для повторного выполнения операций.

### Управляющие файлы (Control Files).

Поскольку база данных Oracle является физическим набором связанных файлов данных, то для их синхронизации и контроля
требуется особые методы. Для этих целей используются управляющие файлы.

База данных Oracle может иметь один или несколько управляющих файлов. Если имеется несколько управляющих файлов, все они
должны быть абсолютно идентичными. При каждом запуске базы данных Oracle читает информацию управляющего файла, а при
каждом изменении размещения или добавления новых файлов данных и журналов базы данных обновляет управляющий файл.

### Файлы параметров pfile, spfie (Parameter Files).

Файлы параметров используются для конфигурирования действий Oracle предже всего при старте. Для того, чтобы запустить
экземпляр базы данных, Oracle должен прочесть файл параметров и определить, какие параметры инициализации установлены для
этого экземпляра. В файле параметров содержатся многочисленные параметры и их установленные значения. Oracle считывает
файл параметров при запуске базы данных. Можно создать несколько файлов параметров, каждый будет соответствовать различным
конфигурациям экземпляра.

###### *spfile* - бинарный файл, который используется сервером Oracle при старте. ####/u01/app/oracle/product/12.2.0/ dbhome_1/dbs
###### *pfile* - текстовый файл с параметрами, будет использоваться при старте, если не будет найден spfile.

Преимущество spfile заключается в том, что при работе с базой данных, любые изменения в базе касающиеся изменения
параметра системы, автоматически записываются в данный файл. Если используется pfile, для сохранения изменений, необходимо
либо “руками вносить эти изменения” в текстовый файл, либо в консоли выполнять команды для создания данных файлов Ораклом.

### Архивные файлы журналов повтора (Archive Log Files).

Как только оперативный файл журнала повтора (Redolog) оказывается заполнен, программное обеспечение сервера Oracle
начинает запись в следующий файл. Эта операция повторяется, как следствие информация в оперативных файлах журнала
(Redolog) многократно перезаписывается.
Если необходимо сохранить историю изменений, нужно, чтобы после переключения журналов сохранялась их копия. Для этого
достаточно перевести работу базы данных в режим работы ARCHIVELOG.

Архивные файлы журналов повтора жизненно важны при восстановлении. Если часть базы данных потеряна или повреждена, то для
устранения повреждений обычно требуется несколько архивных журналов. Файлы журналов повтора должны применяться к базе
данных последовательно. Если один из архивных файлов журналов повтора пропущен, то остальные архивные файлы журналов не
могут использоваться. Храните все свои архивные файлы журналов повтора с момента выполнения последней резервной копии.
Файлы журналов постепенно накапливаются и разрастаются. Иногда необходимо их удалять. Все операции с данными файлами по
применению их к базе выполняются исключительно средствами базы данных. А копировать и переносить их при желании можно как
угодно. Бездумно удалять их руками не рекомендуется.

##### ARCHIVELOG.

Режим работы базы данных, при котором после переключения активной журнальной группы, копия журнала архивируется и
сохраняется на диск. Redo-лог журналы постепенно перезаписываются, а информация которая в них хранилась может быть
получена из архивлогов.
В режиме работы ARCHIVELOG архивные журналы накапливаются и если свободного места нет, база данных прекращает работу. Если
свободного места совсем нет, можно застрять надолго.
В режиме работы ARCHIVELOG для создания бекапа не нужно останавливать работу базы, поэтому обычно базы данных работают
именно в этом режиме.

FRA (Fast Recovery Area) -область на диске для резервных копий и архивных журналов. Впрочем совсем необязательно хранить
бекапы именно в ней. Преимущество использования - возможность ограничения использования ресурсов жестких дисков для
бекапов и архивных журналов. В настройка Oracle задается, где эта область располагается и сколько в ней может храниться
данных. Лучше под FRA не задавать максимально большое значение которое можно выделить под эту задачу, чтобы если что иметь
возможность для маневра. По хорошему, нужно мониторить свободное место в FRA. Если место закончится, сервер отановится.

### Alert log и трассировочные файлы (trace file).

При работе базы данных события и ошибки регистрируются в текстовых файлах на сервере базы данных. Файл журнала
предупреждений (alert log) нужен администратору базы данных для отслеживания важнейших действий с базой данных - наподобие
открытия и закрытия базы данных, установления параметров загрузки базы данных и переключения оперативных журналов повтора.
Также в эти файлы записываются многие ошибки базы данных для последующего расследования их причин. Любые структурные
изменения базы данных также регистрируются в файле журнала предупреждений.

##### Alert log находится:
		/u01/app/oracle/diag/rdbms/valentin/valentin/trace    ## где valentin это имя instance #####
		SQL> show parapeter diag  

### Файлы паролей (Password File).
Необязательный файл, используется для защиты информации о подключениях привилегированных пользователей. Если отсутствует,
то вы можете выполнять администрирование своей базы данных, только локально. Кроме того, с его помощью контролируется
количество привилегированных подключений для управления в одно и то же время.

# SGA (system global area).

Экземпляр БД Oracle состоит из блоков разделяемой памяти, называемых system global area (SGA) и background процессов.

SGA содержит три обязательные структуры данных:

```
Thedatabasebuffercache - содержит копии блоков данных считанные из файлов данных

Thelogbuffer - содержит данные о транзакциях которые ещё не записаны в redolog

Thesharedpool - содержит проверенные SQL выражения и кэш словаря данных, содержащий таблицы, представления и триггеры
```
    Также дополнительно могут быть:
    Largepool
    Javapool
    Streemspool

*Пользовательские сессии тоже требуют памяти на сервере. Это неразделяемая область памяти, которая
называется PGA. У каждой сессии своя PGA.*

### Database buffer cache – это область где выполняются SQL команды.

Когда мы обновляем данные, они не изменяются непосредственно в файлах данных на жёстком диске. Блоки данных, которые содержат данные с которыми мы работаем вначале
копируются в buffer cache.
Изменения (вставка, измнение или удаление данных) применяются к этим копиям данных в буфферном кэше.
Когда мы хотим посмотреть какие-то данные – операция выдачи информации тоже происходит через кэш. Вначале находятся блоки данных которые мы запросили и копируются в
буфер кэш; Затем нужные данные переносятся в PGA для дальнейшей обработки.

### Буфер логов (log buffer).

Log buffer – это небольшая, краткосрочная выделенная область памяти для хранения записей изменений (change vector) до записи их в журнал (redo log) на диске. Запись
изменений – это изменение произошедшее с чем либо;выполнений DML команд создаёт записи изменений.Сохранение всех таких записей это гарантия того, что данные никогда
не будут утеряны.

# The shared pool.

Shared pool самая сложная область в SGA. Она состоит из под-областей, которые управляются Oracle сервером. Управление этими структурами происходит автоматически.
Размер изменяется динамически в зависимости от использования, но не превышает размер всей области памяти.

Мы обсудим только 4 кмпонента:
```

Library cache

Data dictionary cache

PL/SQL area

SQL PL/SQL function result cache
```

Library cache это область памяти где хранятся последние выполненные запросы в разобранном виде.

Data dictionary cache иногда называют row cache. В нём хранятся определения использованных объектов: описания таблиц, индексов, пользователей и другие мета-данные.
Хранения этих данных в кэше в памяти SGA, где они доступны для всех сессий, в отличии от чтения их со словаря данных с диска, сильно увеличивает производительность
разбора команд.

Область PL/SQL (PL/SQL Area). Объектами PL/SQL являются процедуры, функции, пакеты, сложные типы, триггеры.Когда PL/SQL объект вызывается сессией, необходимо
прочитать нужную информацию из словаря данных. Для того чтобы исключить повторное чтение, эти объекты кэшируются в области PL/SQL в shared pool.

SQL Query and PL/SQL Function Result Cache.  Во многих приложениях, одинаковые запросы выполняются много раз,  или одной сессией или разными. Создание этого кэша
позволило Oracle серверу хранить результаты подобных запросов в памяти. Когда запрос будет выполняться повторно вместо его реального выполнения, результат возьмётся
из кэша.

##### Каждому серверному процессу, обслуживающему клиента, выделяется область приватной памяти, называемая областью **PGA**. Область PGA представляет собой
неразделяемую область памяти, которая создается Oracle при запуске серверного процесса и автоматически освобождается по завершении данного сеанса.

# Процессы экземпляра БД.

Background process-ы экземпляра запускаются при запуске инстанса и работают до его выключения.

Пять процессов, которые существуют очень давно: Sysmte Monitor (SMON), Process Monitor (PMON), Database Writer (DBWn), Log Writer (LGWR) и Checkpoint process (CKPT).
```
SMON (системный монитор)

PMON (process monitor)

DBWn (Database Writer)

LGWR, Log Writer

CKPT, Checkpoint Process

MMON, Manageability Monitor

ARCn, Archiver
```

### SMON (системный монитор).

Основной задачей этого процесса является «подключение» (mounting) и «открытие» базы данных. SMON «подключается» используя файл управления (control file). Затем
«открывает» базу для работы путём поиска и проверки всех файлов данных и файлов журнало изменений. Как только база запущена, SMON ответственен за разные задачи к
примеру за объединение пустого места в файлах данных.

### PMON (process monitor).

Пользовательская сессия это пользовательский процесс подключенный к серверному процессу. Серверный процесс запускается когда сессия создается и уничтожается когда
сессия заканчивается. Обычное завершение сессии влючает в себя выход пользователя. Когда это происходит, серверный процесс будет аккуратно завершён. Если сессия
прерывается «неожиданным» образов (например пользовательский компьютер перезагрузился), то сессия остаётся «висеть» в памяти и должна быть как-то закрыта. PMON
смотрит за всеми серверными процессами и ищет «висящие» сессии. Если найдена такая сессия, PMON остановит серверный процесс, вернёт PGA память операционной системе
и отменит все неподтверждённые операции пользователя. #######PMON читает читает параметр файл и контрол файл.#############

### DBWn (Database Writer).

Всегда надо помнить что сессии не работают с информацией на диске. Они работают с данными в buffer cache. А уже database writer в дальнейшем записывает информацию
из buffer cache на диск. Database writer процессов может быть несколько (максимально 12) которые будут называться DBW0, DBW1 и т.д. Отсюда в сокращении буква n в
конце. По умолчанию один database writer на 8 процессоров.

### LGWR (Log Writer).

LGWR записывает информацию из буфера логов в файл лога на диске.

### CKPT (Checkpoint Process).

Когда приложение запрашивает данные, база складывает их в буферный кэш — область памяти в SGA. Когда данные изменяются, база производит изменения не непосредственно
в файле данных, а в буферном кэше. Одновременно в отдельную область памяти — redo log buffer — записывается информация, по которой, в случае необходимости, можно
будет повторить произошедшее изменение. Когда изменение фиксируется (commit), оно, опять же, не сбрасывается сразу в файл данных, но информация из redo log buffer
сбрасывается в online redo лог — специально для этого предназначенный файл. До тех пор, пока изменение не записано в файл данных, необходимо хранить информацию о
нём где-то на диске на тот случай, если база упадёт. Если, к примеру, выключится питание сервера, то, само собой, все данные, хранящиеся в памяти, будут потеряны. В
этом случае redo лог — это единственное место, где хранится информация о произошедшем изменении. После рестарта базы Oracle фактически повторит прошедшую
транзакцию, вновь изменит нужные блоки и сделает commit. Поэтому до тех пор, пока информация из redo лога не будет сброшена в файл данных, повторно использовать
этот redo лог невозможно.

Специальный фоновый процесс базы данных DBWn по мере необходимости освобождает буферный кэш, а также выполняет событие контрольной точки (checkpoint). Контрольная
точка — это событие, во время которого «грязные» (изменённые) блоки записываются в файлы данных.

*За событие контрольной точки отвечает процесс CKPT (checkpoint process)*, который и пишет информацию о контрольной точке в control file и заголовки файлов
данных. Событие контрольной точки обеспечивает согласованность данных и быстрое восстановление базы.

######Потоковые контрольные точки (thread checkpoins).

В файл данных пишутся подряд все изменения, произошедшие в рамках определённого экземпляра до определённого момента.
Случаются они в следующих ситуациях:
```

полная остановка базы;

altersystemcheckpoint;

переключение online redo лога;

alter database begin backup.
```

######Контрольные точки файлов данных и табличных пространств.

Случаются, когда происходят операции с табличными пространствами и файлами данных (alter tablespace offline, alter tablespace read only, ужатие файла данных и.т.п.)

######Инкрементальные контрольные точки.

Подвид контрольной точки экземпляра, предназначенный для того, чтобы избежать записи на диск огромного количества блоков во время переключения redo логов.

###MMON, Manageability Monitor.

MMON — это процесс, который появился после версии 10g, и он позволяет использовать различные функции мониторинга и оптимизации системы. Инстанс собирает различную
статистику о работе с БД и производительности. Эти данные хранятся в SGA и текущие значения можно просмотреть используя SQL запросы. Для оптимизации
производительности, исторического анализа и анализа тренда изменений надо эти значения сохранять на протяжении отрезка времени. MMON регулярно (по умолчанию каждый
час) сохраняет значения из SGA в словарь данных, где эти данные могут храниться бесконечно (по умолчанию хранятся последние восемь дней).

Каждый раз при сохранении набора статистических данны (такой набор называют snapshot), MMON также запускает Automatic Database Diagnostic Monitor (ADDM). ADDM – это
иснтрумент анализа работы БД с помощью, разрабатываемый на протяжении многих лет различными DBA. Он сравнивает два snapshot-а (текущий и предыдущий) и на основании
анализа предлагает рекомендации по настройке БД.

###ARCn, Archiver.

Все записи об изменениях данных в буфере записываются в буфер логов и затем на диск процессом LGWR. Количество и разимер этих логов фиксированны. Когда они
заполняются, LGWR будет перезаписывать их новой информацией. Это значит что только последние изменения будут доступны. Чтобы сохранить полную историю – файлы логов
(online redo logs) необходимо скопировать перед тем как перезаписывать. Этим занимаются процессы ARCn. Если у нас есть эти копии (archive redo logs) то мы можем
восставонить информацию после любых сбоев. Вначале восстанавливается копия файлов данных на определенный момент времени, затем «накатываются» изменения из архива
логов с момента создания копии файлов данных, и в последнюю очередь восстанавливаются изменения из online redo log-ов.

#Описание этапов запуска и остановки БД

Нельзя запустить и остановить БД: только экземпляр может быть запущен и остановлен, а база данных может быть подключена, открыта, отключена и закрыта.
Необходимо помнить что экземпляр БД и база данных это два разных объекта которые могут существовать независимо друг от друга. Когда останавливается экземпляр БД то
структуры в памяти и фоновые процессы перестают существовать, однако база данных (содержимое файлов) продолжает.

**Процесс запуска базы данных разбит на шаги: вначале запускается экземпляр БД, затем база данных подключается (mount) и открывается (open) для использования. В
любой момент времени база данных может быть в одном из следующих состояний:**
```

SHUTDOWN

NOMOUNT необходим файл параметров

MOUNT использует файл контроля

OPEN читает файлы данных и файлы логов
```

Когда база данных остановлена (SHUTDOWN) все файлы закрыты и экземпляр не существует. В отключенном состоянии (NOMOUNT) – экземпляр БД построен в памяти (SGA
создана и фоновые процессы запущены согдасно файлу параметров), но база данных недоступна и может быть даже ещё не создана. В подключенном состоянии (MOUNT)
экземпляр находит и читает файл контроля. В открытом состоянии (OPEN) все файлы найдены и открыты – т.е. база данных доступна для пользователей. Когды вы запускаете
команду STARTUP – будут выполнены все шаги, однако команда может быть разбиты на этапы. Напирмер если файл контроля испорчен или копия недоступна – вы не сможете
подключить базу данных. Однако вы можете запустить базу в неподключенном режиме (NOMOUNT) и восстановить файл контроля. Точно так же если у вас возникли проблемы с
файлами данных или логовов, вы можете попробовать восстановить данные в MOUNT состоянии, перед тем как открывать БД.

*Когда вы запускаете команду STARTUP, Oracle будет искать файл параметров в определённом порядке:*
```

$ORACLE_HOME/dbs/spfileSID.ora
$ORACLE_HOME/dbs/spfile.ora
$ORACLE_HOME/dbs/initSID.ora
```

Во всех случаях – SID это имя экземпляра. Порядок поиска очень важен. Oracle будет использовать первый найденный файл вне зависимости от наличия остальных. Если ни
одного файла не существует – экземпляр не будет запущен. В режиме NOMOUNT используются только файл параметров и системный журнал. Значения параметров из файла
параметров используются для создания SGA в памяти и запуска фоновых процессов.

Когда экземпляр запущен в режиме NOMOUNT, переход в состояние MOUNT будет осуществляться путём чтения файла контроля.

**Остановка процесс зеркальный запуску.**

Вначале закрывается БД (CLOSE), затем отключается (DISMOUNT) и далее останавливается экземпляр. Во время закрытия БД все сессии отключаются: текущие транзакции
отменяются процессом PMON, подтверждённые транзакции записываются в файлы данных DBWn и файлы данных и логов закрываются. Во время отключения закрывается файл
контроля. И экземпляр останавливается с освобождением памяти и остановкой фоновых процессов.

Существуют параметры которые используются с командой SHUTDOWN :
```

SHUTDOWN [NORMAL|TRANSACTIONAL|IMMEDIATE|ABORT]

NORMAL: это значение по умолчанию. Новые подключения нельзя создать, но все текущие сессии могут работать до конца сессии. Когда все пользователю отключатся база
данных будет выключена

TRANSACTIONAL: новые подключения недоступны; существующие сессии которые не выполняют транзакции отключаются; сессии которые выполняют транзанкцию завершают
транзакцию и отключаются. Когда все сессии будут отключены, база данных останавливается.

IMMEDIATE: новые подключения не разрешены. Все активные сессии отключаются. Все активные транзакции отменяются и база данных выключается.

ABORT: это эквивалент отключению питания. Экземпляр останавливается без записи чего либо на диск, закрытия файлов, отмены транзакций.
```

#Использование системного журнала (Alert Log) и файлов трассировки (Trace Files).

######Системный журнал это файл содержащий последовательные записи всех значимых операций совершённых над экземпляром БД и самой базой данных. Местонахождение этого
файла
определяется параметром BACKGROUND_DUMP_DEST и имя alert_SID.log где SID это имя экзмепляра БД.

Значимым операциями записываемыми в системный журнал являются:
```

Запуск и остановка БД (включая шаги подключения и открытия)

Системные внутренние ошибки Oracle (например ошибка ORA-600)

Любые найденные повреждения блоков файлов данных

Возможные ситуации deadlock

Изменения физической структуры БД (создание/изменение файлов данных или файлов логов)

Выполнение команд ALTER SYSTEM

Переключение логов (log switch) и архивирование логов
```

*В системном журнале будут отображеные все значения параметров не по умолчанию при запуске системы. Эта информация вместе со всеми записями выполнения команд ALTER
SYSTEM и ALTER DATABASE позволяют в любой момент времени восстановить историю изменений БД и экземпляра. Это может быть незаменимой информацией при поиске источника
возникновения проблемы.*

######Файлы трассировки создаются различными фоновыми процессами, обычно когда возникает ошибка. Эти файлы хранятся в той же директории где и системный журнал. Если
фоновый процесс не отработал коррекно из-за какой либо ошибки – будет создан файл трассировки, который может помочь в обнаружении проблемы.

#Использование словаря данных и динамических представлений производительности
