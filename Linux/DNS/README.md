# Настройка и установка сервиса DNS BIND

## Установть bind на dns сервер
```

# yum install bind bind-utils
```

## Настройка основного DNS сервера

#### Открыть в текстовом редакторе c правами суперпользователя файл /etc/named.conf и внести изменения:
```
Над существующим блоком + options + создайте новый блок ACL, который называется «доверенный». Здесь мы определим список клиентов, которым мы будем разрешать рекурсивные DNS-запросы (т.е. ваши серверы, которые находятся в том же центре обработки данных, что и dns server (ip 192.168.1.3)):

acl "trusted" {
      192.168.1.3;
      192.168.1.2;
};


Теперь, когда у нас есть список доверенных DNS-клиентов, нам нужно отредактировать блок + options +. Добавьте частный IP-адрес (dns server (ip 192.168.1.3)) в директиву + listen-on port 53 + и закомментируйте строку + listen-on-v6 + и внести изменения следующие изменения (места помечены ########):

options {

        listen-on port 53 { 127.0.0.1; 192.168.1.3; };   ######
        // listen-on-v6 port 53 { ::1; };                ######
		directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { any; };                        #########
		 recursion yes;
        forwarders {                                     #########
                8.8.8.8;
                8.8.4.4;
        };
        forward only;
        dnssec-enable yes;
        dnssec-validation yes;

        /* Path to ISC DLV key */
        bindkeys-file "/etc/named.root.key";

        managed-keys-directory "/var/named/dynamic";

        pid-file "/run/named/named.pid";
        session-keyfile "/run/named/session.key";
};

logging {
        channel default_debug {
                file "data/named.run";
                severity dynamic;
        };
};

zone "." IN {
        type hint;
        file "named.ca";
};

include "/etc/named.rfc1912.zones";
include "/etc/named.root.key";
include "/etc/named/named.conf.local";                #############  добавляем эту строку - путь к локальному файлу


Сохраняем и закрываем
```

#### Настройка локального файла named.conf.local

Открываем файл  /etc/named/named.conf.local в текстовом редакторе. Файл должен быть пустым. Здесь мы укажем нашу прямую и обратную зоны.
```
Добавьте прямую зону следующими строками (замените имя зоны своим):

zone "valentin.ru" {
        type master;
        file "/etc/named/zones/db.valentin.ru";
};


добавьте обратную зону с помощью следующих строк

zone "168.192.in-addr.arpa" {                           ############     Предполагая, что наша частная подсеть 192.168.1.0
        type master;
        file "/etc/named/zones/db.192.168";
};

Сохраняем и закрываем
```
#### Теперь, когда наши зоны указаны в BIND, нам нужно создать соответствующие файлы прямой и обратной зон.

###### СОЗДАТЬ ФАЙЛ ПРЯМОЙ ЗОНЫ

*Файл прямой зоны - это место, где мы определяем записи DNS для прямого поиска DNS.*
Давайте создадим каталог, в котором будут находиться наши файлы зон. Согласно нашей конфигурации named.conf.local, это расположение должно быть + / etc / named / zones +:
```

mkdir /etc/named/zones
```

Теперь давайте создадиим и отредактируем наш файл прямой зоны:

```
создаем файл прямой зоны при помощи любого текстового редактора

/etc/named/zones/db.valentin.ru

содержание должно быть примерно следующим :

$TTL    604800
@       IN      SOA     valentin.ru. admin.valentin.ru. (
              2        ; Serial  ### Каждый раз, когда вы редактируете файл зоны, вы должны увеличивать значение serial, прежде чем перезапускать процесс + named +
            604800     ; Refresh
             86400     ; Retry
           2419200     ; Expire
            604800 )   ; Negative Cache TTL

; name servers - NS records
   IN      NS      dns-srv                      ##### указываем DNS-server

; name servers - A records
dns-srv        IN      A  192.168.1.3           #### указываем DNS-server и его ip
oracle-db      IN      A  192.168.1.2           #### указываем клиенты (хосты) и их ip

сохраняем и закрываем
```
###### СОЗДАТЬ ФАЙЛ ОБРАТНОЙ ЗОНЫ

*Файл обратной зоны - это место, где мы определяем записи DNS PTR для обратного поиска DNS.*
```

Создаем в каталоге /etc/named/zones файл обратной зоны db.192.168

открываем в любом текстовом редакторе файл */etc/named/zones/db.192.168* и аналогичным и редактируем его:

$TTL    604800
@       IN      SOA     db.valentin.ru admin.db.valentin.ru. (                  ### указываем полное доменное имя
              2        ; Serial
            604800     ; Refresh
             86400     ; Retry
           2419200     ; Expire
            604800 )   ; Negative Cache TTL

; name servers - NS records
   IN      NS      dns-srv.valentin.ru.                                       ###  указываем DNS-server      

; name servers - PTR Records                                                  ###  указывается только последние два октета ip в одбартном порядке (пример для ip 192.168.1.3)
3.1      IN      PTR  dns-srv.valentin.ru.                                    ###  указываем DNS server            
2.1      IN      PTR  oracle-db.valentin.ru.	                                ### указываем клиенты (хосты) и их ip  

Сохраняем и закрываем файл
```
###### НЕМНОГО ТЕОРИИ (описание содержания файла зоны)

SOA (Start of Authority/начальная запись зоны) — описывает основные/начальные настройки зоны, можно сказать, определяет зону ответственности данного сервера. Для каждой зоны должна существовать только одна запись SOA и она должна быть первая. Поле Name содержит имя домена/зоны, поля TTL, CLASS — стандартное значение, поле TYPE принимает значение SOA, а поле DATA состоит из нескольких значений, разделенных пробелами: имя главного DNS (Primary Name Server), адрес администратора зоны, далее в скобках — серийный номер файла зоны (Serial number). При каждом внесении изменений в файл зоны данное значение необходимо увеличивать, это указывает вторичным серверам, что зона изменена, и что им необходимо обновить у себя зону. Далее — значения таймеров (Refresh — указывает, как часто вторичные серверы должны опрашивать первичный, чтобы узнать, не увеличился ли серийный номер зоны, Retry — время ожидания после неудачной попытки опроса, Expire — максимальное время, в течение которого вторичный сервер может использовать информацию о полученной зоне, Minimum TTL — минимальное время, в течение которого данные остаются в кэше вторичного сервера).
Запись ресурса состоит из следующих полей:
>имя (NAME) — доменное имя, к которому привязана или которому «принадлежит» данная ресурсная запись, либо IP адрес. При отсутствии данного поля, запись ресурса наследуется от предыдущей записи.
>Time To Live (TTL) — дословно «время жизни» записи, время хранения записи в кэше DNS (после указанного времени запись удаляется), данное поле может не указываться в индивидуальных записях ресурсов, но тогда оно должно быть указано в начале файла зоны и будет наследоваться всеми записями.
>класс (CLASS) — определяет тип сети, (в 99,99% случаях используется IN (что обозначает — Internet). Данное поле было создано из предположения, что DNS может работать и в других типах сетей, кроме TCP/IP)
>тип (TYPE) — тип записи синтаксис и назначение записи
>данные (DATA) — различная информация, формат и синтаксис которой определяется типом.

При этом, возможно использовать следующие символы:
>  ;  Вводит комментарий. #  Также вводит комментарии (только в версии BIND 4.9)                                           
>  @  Имя текущего домена
>  ( ) Позволяют данным занимать несколько строк
>  *  Метасимвол (только в поле имя)

Наиболее часто применяемые ресурсные записи следующие:
>A — (address record/запись адреса) отображают имя хоста (доменное имя) на адрес IPv4. Для каждого сетевого интерфейса машины должна быть сделана одна A-запись.
>AAAA (IPv6 address record) аналогична записи A, но для IPv6.
>CNAME (canonical name record/каноническая запись имени (псевдоним)) — отображает алиас на реальное имя (для перенаправления на другое имя), н
>MX (mail exchange) — указывает хосты для доставки почты, адресованной домену. При этом поле NAME указывает домен назначения, поля TTL, CLASS — стандартное значение, поле TYPE принимает значение MX, а поле DATA указывает приоритет и через пробел - доменное имя хоста, ответственного за прием почты. Например, следующая запись показывает, что для домена k-max.name направлять почту сначала на mx.k-max.name, затем на mx2.k-max.name, если с mx.k-max.name возникли какие-то проблемы. При этом, для обоих MX хостов должны быть соответствующие A-записи:
>NS (name server/сервер имён) указывает на DNS-сервер, обслуживающий данный домен. Вернее будет сказать — указывают сервера, на которые делегирован данный домен. Если записи NS относятся к серверам имен для текущей зоны, доменная система имен их практически не использует. Они просто поясняют, как организована зона и какие машины играют ключевую роль в обеспечении сервиса имен.
>PTR (pointer) — отображает IP-адрес в доменное имя (о данном типе записи поговорим ниже в разделе обратного преобразования имен).

#### ПРОВЕРЯЕМ СИНТАКСИС КОНФИГУРАЦИИ BIND

Выполните следующую команду, чтобы проверить синтаксис файлов + named.conf * +:

P.s. Если в ваших именованных файлах конфигурации нет синтаксических ошибок, вы вернетесь к приглашению оболочки и не увидите сообщений об ошибках.
```
$ sudo named-checkconf
```
#### ЗАПУСК BIND
```

$ sudo systemctl start named
```

добавить BIND в автозагрузку :
```
$ sudo systemctl enable named
```
## Настрока DNS-клиента

*Прежде чем все ваши серверы в «доверенном» ACL-списке смогут запрашивать ваши DNS-серверы, вы должны настроить каждый из них для использования ранее настоенного сервера в качестве серверов имен. Этот процесс варьируется в зависимости от ОС, но для большинства дистрибутивов Linux он включает добавление ваших серверов имен в файл + / etc / resolv.conf +.*

#### В CentOS, RedHat и Fedora Linux VPS просто отредактируйте файл + resolv.conf +:
```

$ sudo vi /etc/resolv.conf

Затем добавьте следующие строки в начало файла (замените IP-адреса на IP-адреса DNS сервера):
/etc/resolv.conf

search   # your private domain. Cписок для поиска имен машин. Ипользуется для resolva имен по короткому имени (указывается зона, например valentin.ru)
nameserver 192.168.1.3  # DNS IP address

Сохранить и выйти.
```
Ваш клиент теперь настроен на использование ваших DNS-серверов.
